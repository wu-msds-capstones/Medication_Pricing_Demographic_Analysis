# Results

Our primary hypothesis was that certain demographic groups may experience greater hardship due to rising medication prices, particularly in counties where these demographics are concentrated. We asked whether it’s possible to use county-level demographic data, along with median medication prices, to build a predictive model for drug costs. If successful, such a model could offer short-term guidance, helping individuals with specific medical needs identify counties with more favorable pricing, and long-term potential to inform policy and industry efforts aimed at addressing pricing inequities.

## Statistical Testing - Phase 1

To consider the impact to different demographics by varying prices for the selected drugs, our team constructed a series of hypotheses.  The first consideration was towards race.  The majority of U.S. counties contain percentages which heavily tilt towards individuals who identify as white.  In fact, when evaluating the percentages across all counties throughout the US, counties are 95% white at the median and 93% at the mean.  For our first test, we elected to evaluate counties that were at least 95% white and those below that threshold.

Before proceeding, we had to address assumptions which would be critical to determining which tests could actually apply.  We did not initially feel confident applying the assumption of normality to our data.  The spread of the median and mean price values across counties and within various medication groups did visually appear normal.  However, after applying the Shapiro-Wilk test, Shapiro p-values were all significantly below 0.05 which indicated a lack of normalcy.  Accordingly our team chose a non-parametric test to evaluate our hypotheses.  The Anderson-Darling test was explored as an alternative to the Shapiro-Wilk test, but the results were similar, with high AD statistic values, suggesting a lack of normality. 

The Wilcoxon rank-sum (Mann-Whitney U) test was selected to evaluate two independent groups, specified by the hypothesis threshold.  We considered the observations to be independent of each other since the census is completed at the county level, with no counties overlapping.

Ultimately, the Mann-Whitney U Test is less powerful than parametric tests when assumptions are met.  It also lacks confidence intervals and is only comparing the ranks and not the actual values.  The benefit of taking this approach for our data is that fewer overall assumptions are necessary.  Since our team was condensing a number of variables, this approach was preferred to starting with an excessive number of assumptions.

### Hypothesis 1

*Null Hypothesis:* The distribution of medication costs in counties with >=95% white population is not statistically different from the distribution in counties with <95% white population.

*Alternative Hypothesis:* The distribution of medication costs in counties with >= 95% white population is statistically different from that in counties with <95% white population.

*Assumptions:* 

1. – Independent groups
2. – Ordinal or continuous data
3. – Same Shape of Distribution (when comparing medians)
4. – Random Sampling
5. – Independence within each group

Accordingly, our team elected to compare mean prices, which notably exposes our analysis to outlier pricing.  The assumption independence within each group is stretched, considering the manner in which the data was procured, which we have discussed in great detail.

| Drug Name               | p-value        |
|------------------------|----------------|
| Adalimumab             | 3.37e-21        |
| Apixaban               | 5.46e-21        |
| Insulin Aspart         | 6.31e-18        |
| Semaglutide            | 2.53e-13        |
| Paliperidone Palmitate | 6.19e-13        |
| Rivaroxaban            | 4.67e-12        |
| Liraglutide            | 1.44e-10        |
| Empagliflozin          | 4.23e-04        |
| Tiotropium Bromide     | 1.16e-02        |
| Dulaglutide            | 1.30e-02        |
| Lenalidomide           | 6.55e-02        |
| Etanercept             | 7.12e-02        |
| Ustekinumab            | 7.29e-02        |
| Ibrutinib              | 4.93e-01        |

: P-value results for Hypothesis 1 {#tbl-h1 .striped .hover tbl-colwidths="[50,50]"}  

We can reasonably conclude from this that in 10 of our 14 focus medications, there is a statistically significant difference in mean prices and reject the null hypothesis for these medications. (See @tbl-h1.) To dive deeper, our team constructed density plots to compare the direction of this difference.  As observed in @fig-h1, where we evaluate two of these medications.  We can clearly see that the direction shifts at different price ranks and depends on the medication.

```{r}
#| label: fig-h1
#| fig-cap: "Hypothesis 1 - Comparing GLP-1 receptor agonists, primarily used for type 2 diabetes management"
#| warning: false
#| echo: false
#| message: false

library(tidyverse)

h_df_clean = readRDS("data/h_df_clean.rds")

h_df_clean%>%
  filter(drug_name_clean %in% c("Dulaglutide", "Semaglutide"))%>%
  group_by(drug_name_clean) %>%
  filter(
    mean_price > quantile(mean_price, 0.25) - 1.5 * IQR(mean_price) &
      mean_price < quantile(mean_price, 0.75) + 1.5 * IQR(mean_price)
  )%>%
  ungroup()%>%
  ggplot(aes(x = mean_price, fill = white_95)) +
  geom_density(alpha = 0.5) +
  scale_fill_manual(values = c("#440154", "#FDE725"),
                    labels = c("<95% White", "≥95% White")) +
  labs(
    title = "Density Plots of Mean Drug Prices by County Demographics",
    x = "Mean Price",
    y = "Density",
    fill = "County Group",
    caption = "*Outliers removed"
  ) +
  scale_x_continuous(labels = scales::label_dollar(accuracy=1))+
  facet_grid(.~ drug_name_clean, scales = "free") +
  theme_minimal()+
  theme(panel.spacing = unit(1.5, "lines")) 


```

Drilling down again, with these two medications in focus, actual values are compared:

| Drug Name   | >=95% White | Mean of Mean Price | SD Mean Price |
|-------------|----------|----------------|----------------|
| Dulaglutide | FALSE    | 444.00          | 3.74           |
| Dulaglutide | TRUE     | 444.00          | 3.71           |
| Semaglutide | FALSE    | 168.00          | 2.58           |
| Semaglutide | TRUE     | 167.00          | 1.84           |

The findings are interesting but have issues.  In the plot, we can clearly see that advantages are given to certain groups at certain prices.  The mean of the mean prices, as well as the standard deviations show practically no difference for Dulaglutide and only some difference for Semaglutide.  Unfortunately, this does not provide much clarity regarding any particular advantage afforded to counties where more than 95% of the population identifies as white.  The findings are hardly definitive and lack confidence intervals.  This does demonstrate the limitations of using the Mann-Whitney U Test.

### Hypothesis 2

Using the same assumptions, another consideration involves fully removing the racial aspect and instead considering the percentage of the population that is below the poverty level.  Within the census data, the median is 13% below the poverty level, across all counties and 14% at the mean.  We establish a new hypothesis.

*Null Hypothesis:* The distribution of medication costs in counties with >=13% below poverty population is not statistically different from the distribution in counties with <13% below poverty population.

*Alternative Hypothesis:* The distribution of medication costs in counties with >= 13% below poverty population is statistically different from that in counties with <13% below poverty population.

| Drug Name               | p-value        |
|------------------------|----------------|
| Semaglutide            | 1.43e-20        |
| Dulaglutide            | 2.49e-16        |
| Ibrutinib              | 4.41e-13        |
| Insulin Aspart         | 2.34e-10        |
| Adalimumab             | 3.46e-10        |
| Etanercept             | 2.40e-08        |
| Ustekinumab            | 8.88e-08        |
| Apixaban               | 1.90e-06        |
| Empagliflozin          | 6.70e-06        |
| Liraglutide            | 1.12e-03        |
| Lenalidomide           | 1.43e-03        |
| Paliperidone Palmitate | 2.70e-02        |
| Tiotropium Bromide     | 8.55e-02        |
| Rivaroxaban            | 1.54e-01        |

Again, we find that there are statistically significant outcomes for many of the selected medications.  Twelve of the fourteen medications yield p-values below 0.05 suggesting that the null hypothesis be rejected.

In {@fig-h2} we look closer at six medications, to expand the investigation into these differences and the direction of any potential advantage.

```{r}
#| label: fig-h2
#| fig-cap: "Hypothesis 2 - Comparing medications which were indicated for statistically significant differences in price for two poverty groups"
#| warning: false
#| echo: false
#| message: false

library(tidyverse)

h_df_clean = readRDS("data/h_df_clean.rds")

h_df_clean%>%
  filter(drug_name_clean %in% c("Semaglutide", "Dulaglutide"))%>%
  group_by(drug_name_clean) %>%
  filter(
    mean_price > quantile(mean_price, 0.25) - 1.5 * IQR(mean_price) &
      mean_price < quantile(mean_price, 0.75) + 1.5 * IQR(mean_price)
  )%>%
  ungroup()%>%
  ggplot(aes(x = mean_price, fill = poverty_13)) +
  geom_density(alpha = 0.5) +
  scale_fill_manual(values = c("#440154", "#FDE725"),
                    labels = c("<13% Below Poverty", "≥13% Below Poverty")) +
  labs(
    title = "Density Plots of Mean Drug Prices by County Demographics",
    x = "Mean Price",
    y = "Density",
    fill = "County Group",
    caption = "*Outliers removed"
  ) +
  scale_x_continuous(labels = scales::label_dollar())+
  facet_wrap(~ drug_name_clean, scales = "free") +
  theme_minimal()


```

Similar to hypothesis 1, we see that the price differences are contextual to the medication and price rank position.  While the null hypothesis is rejected, the challenge of approaching multiple medications is clearly demonstrated.  For both hypotheses, by rejecting the null, this may result in a type 1 error, or false positive.  There are clearly price differences relative to certain demographic groups.  Whether those differences are being driven by the demographics remained unclear.

## Statistical Testing - Phase 2

In order to further explore statistical significance, we assumed a normal distribution of the data. This assumption enabled the use of traditional parametric testing methods. Specifically, we conducted two-sample t-tests, mirroring the structure used in the first phase of statistical testing, where the dataset was divided based on demographic medians. Additionally, we grouped counties into multiple subsets using demographic quartiles rather than medians, allowing for more granular comparisons. This stratification enabled the application of the Tukey HSD test to assess pairwise differences across these groups.

Using a two-sample t-test allowed reconsideration of our second hypothesis.  We again encountered low p-values.  Selecting for Semaglutide as one example and using the same data split for poverty at the median, the resulting p-value was 2.2e-16 which was a strong indicator for statistical significance, suggesting we reject the null.

Building on this, we applied the Tukey HSD test to the quartile-based groups at a 95% confidence level. Again, we found p-values that supported rejecting the null hypothesis, indicating that the average mean prices across groups were not equal. Interestingly, the only comparisons with p-values at or above 5% occurred between adjacent quartile groups, while all other comparisons yielded p-values well below this threshold.

| Comparison                         | Difference   | Lower CI     | Upper CI     | Adjusted p-value |
|------------------------------------|--------------|--------------|--------------|------------------|
| >17% Poverty - 0-10% Poverty       | -1.1555147   | -1.4430153   | -0.8680141   | 0.0000000        |
| >17% Poverty - 10-13% Poverty      | -0.8564752   | -1.1503721   | -0.5625784   | 0.0000000        |
| >17% Poverty - 13-17% Poverty      | -0.6371890   | -0.9262280   | -0.3481500   | 0.0000001        |
| 13-17% Poverty - 0-10% Poverty     | -0.5183257   | -0.8123963   | -0.2242551   | 0.0000361        |
| 10-13% Poverty - 0-10% Poverty     | -0.2990395   | -0.5978861   | -0.0001928   | 0.0497806        |
| 13-17% Poverty - 10-13% Poverty    | -0.2192862   | -0.5196131   |  0.0810407   | 0.2382320        |

We repeated this process across several medications and demographic variables, consistently observing statistical significance. However, when examining the actual differences in average prices between groups, the magnitude of these differences was often minimal. Continuing with Semaglutide as an example, counties in the lowest poverty quartile (0–10%) had an average mean price of $168, while those in the highest poverty quartile (>17%) had an average of $167, a mere $1 difference. Notably, counties with higher poverty levels were paying slightly less on average.

To better understand the implications of this finding, we considered affordability by dividing the mean price by the median income of each county. This revealed that although prices were lower in higher-poverty areas, the cost represented a larger proportion of income, highlighting a disparity in affordability. This relationship is clearly illustrated in the following table and @fig-h2_2.

| Poverty Group       | Mean Price | SD Price | Mean Affordability | SD Affordability | Sample Size (n) |
|---------------------|------------|----------|---------------------|------------------|------------------|
| 0–10% Poverty       | 168.00     | 2.35     | 0.00209             | 0.000409         | 788              |
| 10–13% Poverty      | 168.00     | 2.60     | 0.00246             | 0.000332         | 725              |
| 13–17% Poverty      | 167.00     | 2.36     | 0.00275             | 0.000351         | 772              |
| >17% Poverty        | 167.00     | 1.69     | 0.00340             | 0.000613         | 846              |

```{r}
#| label: fig-h2_2
#| fig-cap: "Parametric Testing - Exploring affordability for Semaglutide across various levels of poverty"
#| warning: false
#| echo: false


library(dplyr)
library(ggplot2)


h_df_clean%>%
  filter(drug_name_clean == "Semaglutide")%>%
  mutate(
    affordability = mean_price/median_household_incomeE,
    poverty_13 = factor(case_when(poverty_13 == TRUE ~ ">=13% Poverty",
                           poverty_13 == FALSE ~ "<13% Poverty"),
                        levels = c(">=13% Poverty", "<13% Poverty")
  ))%>%
  filter(
    affordability > quantile(affordability, 0.25) - 1.5 * IQR(affordability) &
    affordability < quantile(affordability, 0.75) + 1.5 * IQR(affordability)
  ) %>%
  ggplot(aes(x = affordability, fill = poverty_split)) +
  geom_density(alpha = 0.5) +
  scale_fill_viridis_d()+
  theme_minimal() +
  labs(
    title = "Affordability by Poverty Level",
    subtitle = "Semaglutide",
    x = "Affordability (Mean Price / Median Household Income)",
    y = "Density",
    fill = "Poverty Levels",
    caption = "*Outliers removed"
  )



```

We employed both t-tests and Tukey HSD tests to evaluate a range of medications across various demographic subsets, tailoring each analysis to specific hypotheses about potential demographic impacts on drug pricing. While many results showed statistical significance, further inspection revealed that the actual differences in mean prices, affordability metrics, and other summary statistics were often marginal.

This distinction between statistical and practical significance became a turning point. Statistical significance simply indicates that a result is unlikely due to random chance. It does not guarantee that the difference is meaningful or actionable. In our case, the detected differences, though statistically valid, lacked the magnitude necessary to inform policy or guide consumer decisions.

Recognizing this limitation, we pivoted our focus toward structural market factors, particularly the relationship between population size and the number of available Medicare Part D plans in each county. This shift allowed us to explore whether plan availability aligns with population needs, a perspective that offers more tangible insights into affordability and access. By emphasizing market dynamics over demographic predictors, we uncovered patterns that more directly influence pricing and equity across regions.

## Population vs Number of Available Medicare Plans

Given the lack of clear patterns for medication prices across the maps and within isolated demographic groups, we turned to a deep dive into the demographics. Our first dive was into the population. Do counties with a larger population have more Medicare plan options, and does this competition lead to lower drug prices? A scatter plot of the number of Medicare Plans available vs the population per county is shown below with a linear fit to show a trend line. {@fig-plans-vs-population} 


```{r}
#| label: fig-plans-vs-population
#| fig-cap: "Correlation between the number of Medicare Plan Options and Total Population by US County in 23Q4"
#| warning: false
#| echo: false
#| message: false


library(tidyverse)
library(ggplot2)

summary_table = readRDS("data/summary_table_23Q4.rds")

summary_table2 <- summary_table %>%
  filter(!is.na(total_popE))

# Plot population vs
ggplot(summary_table2, aes(x = num_contract_plans, y = total_popE)) +
  geom_point(alpha = 0.6, color = "gray") +
  scale_y_log10(labels = scales::comma) + 
  geom_smooth(method = "lm", color = "black", se = FALSE, linetype = "dashed") +
  
  labs(
    title = "Number of Medicare Plan Options vs Total Population by US County in 23Q4",
    x = "Number of Medicare Plan Options",
    y = "Total Population (log scale)"
  ) +
  theme_minimal(base_size = 10) + 
  theme(
    plot.title.position = "plot",       # aligns title with plot area
    plot.title = element_text(hjust = 0) # hjust = 0 means left-align
  )

```

While there is a slight trend, it is not a great fit overall. The model is statistically significant (p-value < 0.05) and shows a moderate positive relationship (slope = 0.0195, or 1 more medicare plan with a 1.95% increase in the population) between the number of Medicare plans and population. But it's not a strong fit. Two-thirds of the variation in population is left unexplained (adjusted R-squared = 0.3444), so we don’t want to over-interpret this model as being predictive. Given the limited correlation between the number of available plans and population, we don’t think this demographic measure is having much of an impact on medication prices. 
 
From here, we jumped into creating a model across all our demographics (age, education, gender, and racial breakdowns, as well as median income, and percent below the poverty line). 

## Machine Learning

### Check for Gaussian Distributions

Before proceeding into any modeling, one must check the distribution of the variables. For this particular dataset, if all the medications are looked at simultaneously, one needs to take the log of the median prices to have the histogram show a more Gaussian distribution. (See @fig-hist-price-all-drugs). This is due to the fact that the median drug price varies greatly depending on the actual drug being considered. 

```{r}
#| label: fig-hist-price-all-drugs
#| fig-cap: "Histogram of Median Drug Prices and Log-Transformed Median Drug Prices across All Drugs"
#| warning: false
#| fig-height: 4
#| echo: false


summary_table2 = readRDS("data/summary_table2.rds")

# Set up a 1-row, 2-column layout
par(mfrow = c(1, 2))
# Histogram of raw median_price
hist(summary_table2$median_price, 
     breaks = 50, 
     main = "Median Price - All Drugs", 
     xlab = "Price",
     col = "darkgray")
# Histogram of log-transformed median_price
hist(log(summary_table2$median_price), 
     breaks = 50, 
     main = "Log(Median Price) - All Drugs", 
     xlab = "log(Price)",
     col = "lightgray")
# Reset plotting layout
par(mfrow = c(1, 1))
```

If the medications are reviewed independently (@fig-hist-price-per-drug), then we do not need to take the log of the medication prices. The distribution shape doesn’t change with or without the log of the price. Our plan is to look at each drug independently due to the lack of patterns in the correlation heatmaps earlier (@fig-by-drug-correlations).

```{r}
#| label: fig-hist-price-per-drug
#| fig-cap: "Histogram of Median Drug Prices by Drug"
#| warning: false
#| echo: false
#| fig-height: 8

summary_table2 = readRDS("data/summary_table2.rds") %>% filter(!is.na(drug_name_clean))

library(dplyr)
library(ggplot2)

# Plot faceted histograms
ggplot(summary_table2, aes(x = median_price)) +
  geom_histogram(bins = 50, fill = "darkgray") +
  facet_wrap(~ drug_name_clean, scales = "free", ncol = 3) +
  labs(
    title = "Distribution of Median Price by Drug",
    x = "Median Price",
    y = "Count"
  ) +
  theme_minimal(base_size = 10)

```

### Model Selection
In order to model the relationship between medication prices and demographic features, we employed a variety of machine learning algorithms, each with unique strengths and assumptions. Below is a brief overview of the algorithms explored:

**Linear Model (LM):**
Linear regression is a fundamental technique used to model the relationship between a continuous outcome variable and one or more predictors, assuming a linear relationship. It is interpretable and computationally efficient but may underperform when the underlying patterns are nonlinear or complex.

**Elastic Net (ENET):**
Elastic Net is a regularized regression method that combines both L1 (Lasso) and L2 (Ridge) penalties. It is particularly effective when dealing with multicollinearity or when performing variable selection in high-dimensional datasets. Elastic Net encourages sparsity while maintaining group stability among correlated features.


**Gradient Boosting Machine (GBM):**
GBM is an ensemble technique that builds models sequentially, with each new model correcting the errors of the previous one. It is capable of capturing complex nonlinear relationships and is known for its high predictive performance, although it can be prone to overfitting if not properly tuned.


**K-Nearest Neighbors (KNN):**
KNN is a non-parametric algorithm that classifies or predicts outcomes based on the average value (or majority class) of the k closest observations in the feature space. It is simple and intuitive but can struggle with high-dimensional data and is sensitive to the choice of distance metric and value of k.


**Random Forest (RF):**
Random Forest is an ensemble method that constructs a large number of decision trees during training and outputs the average prediction (for regression) or majority vote (for classification). It offers good performance with low risk of overfitting, handles missing data well, and provides insights into feature importance.


**Support Vector Machine (SVM):**
SVM is a powerful classifier and regressor that aims to find the optimal hyperplane that maximally separates classes or fits data with minimal error (via support vectors). It works well in high-dimensional spaces and with complex boundaries but can be computationally intensive and sensitive to kernel and parameter choices.


**Extreme Gradient Boosting (XGBoost):**
XGBoost is an optimized and scalable implementation of gradient boosting. It includes advanced features such as regularization, parallel processing, and handling of missing values. XGBoost typically outperforms many other algorithms in structured data problems and is widely used in machine learning competitions and real-world applications.


### Model Performance

Looping over every drug, we trained all the previously described models. A heatmap of the resulting model performance is provided below in @fig-heatmap-models-performance. As expected, the gradient boosting machine, the random forest, and the extreme gradient boosting models performed the best across all drugs. Unfortunately, while the models ok R^2 values when fitting to the training data, the R^2 values for the test data is significantly lower. This suggests that the models are overfitting to the training data, and we need to tune the hyperparameters of the models to improve performance.


```{r}
#| label: fig-heatmap-models-performance
#| fig-cap: "Model Performance Heatmap by Drug"
#| warning: false
#| echo: false
#| fig-height: 6

library(ggplot2)
library(dplyr)
library(tidyr)
library(scales)

# # Load and prepare data
# model_metrics_df <- readRDS("data/model_metrics_summary.rds")
# 
# metrics_long <- model_metrics_df %>%
#   pivot_longer(cols = c(RMSE, MAE), names_to = "Metric", values_to = "Value") %>%
#   # Normalize Value to [0,1] to assess brightness
#   mutate(fill_norm = rescale(Value),
#          text_color = ifelse(fill_norm > 0.05, "white", "black"))  # text is black if background is light
# 
# ggplot(metrics_long, aes(x = model, y = drug, fill = Value)) +
#   geom_tile(color = "white") +
#   geom_text(aes(label = signif(Value, 2), color = text_color), size = 3, angle = 45, show.legend = FALSE) +
#   scale_color_identity() +  # use colors as-is from the column
#   scale_fill_viridis_c(option = "magma", direction = -1, name = "Metric Value",     
#                        limits = c(min(metrics_long$Value, na.rm = TRUE), 
#                                   quantile(metrics_long$Value, 0.90, na.rm = TRUE))) +
#   facet_wrap(~ Metric, ncol = 2) +
#   labs(
#     title = "Model Performance by Drug (Dynamic Text Contrast)",
#     x = NULL, #"Model",
#     y = NULL #"Drug"
#   ) +
#   theme_minimal(base_size = 12) +
#   theme(
#     axis.text.x = element_text(angle = 45, hjust = 1),
#     plot.title = element_text(hjust = 0),
#     plot.title.position = "plot"
#   )

all_metrics = readRDS("data/all_metrics_untuned_models.rds")

train_metrics <- all_metrics %>% 
  filter(Dataset == "Train") %>% 
  mutate(fill_norm = rescale(Rsquared), 
         text_color = ifelse(fill_norm > 0.25, "white", "black"))  # text is black if background is light
test_metrics  <- all_metrics %>% 
  filter(Dataset == "Test") %>% 
  mutate(fill_norm = rescale(Rsquared), 
         text_color = ifelse(fill_norm > 0.5, "white", "black"))  # text is black if background is light

# Shared fill scale
Rsq_limits <- c(min(all_metrics$Rsquared, na.rm = TRUE),
                quantile(all_metrics$Rsquared, 1, na.rm = TRUE))

# Train Rsquared heatmap
p1 <- ggplot(train_metrics, aes(x = Model, y = Drug, fill = Rsquared)) +
  geom_tile(color = "white") +
  geom_text(aes(label = signif(Rsquared, 1),
                color = text_color),
            size = 3, angle = 45, 
            show.legend = FALSE) +
  scale_color_identity() +  # use colors as-is from the column
  scale_fill_viridis_c(option = "magma", direction = -1, name = "R^2", limits = Rsq_limits) + 
  labs(title = "Training Data Rsquared", x = "Model", y = NULL) +
  theme_minimal(base_size = 10) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Test Rsquared heatmap
p2 <- ggplot(test_metrics, aes(x = Model, y = Drug, fill = Rsquared)) +
  geom_tile(color = "white") +
  geom_text(aes(label = signif(Rsquared, 2),
                color = text_color),
            size = 3, angle = 45, 
            show.legend = FALSE) +
  scale_color_identity() +  # use colors as-is from the column
  scale_fill_viridis_c(option = "magma", direction = -1, name = "R^2", limits = Rsq_limits) +
  labs(title = "Test Data Rsquared", x = "Model", y = NULL) +
  theme_minimal(base_size = 10) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
# Combine
(p1 + p2) + plot_layout(guides = "collect") & theme(legend.position = "right")

```


### Tuning to prevent overfitting
To improve the model performance and prevent overfitting, we tuned the hyperparameters of the extreme gradient boosting models. The tuning process involved adjusting parameters such as the number of rounds, maximum depth, learning rate (aka eta) and more to optimize model performance on the validation set. Our most overfit model XGB6 has a nearly perfect fit to the training data for all drugs, and yet it also has the best fit to the test data. If the model had the key features that drive median price, we would've expected to see the test R^2 values be much closer to the training R^2 values and that there would be a optimum point where the training data might have a worse fit, but the test data would have a better fit in comparison. Tunning the parameters to prevent overfitting, you can see the XGB7-9 get progressively worse fits to the training data, but also worse fits to the test data. Thus, we think that the features that we have are not the best predictors of median drug price. The tuned XGB models are shown in @fig-heatmap-models-performance-tuned.
  
```{r}
#| label: ig-heatmap-models-performance-tuned
#| fig-cap: "Tuned XGB Models Performance Heatmap by Drug"
#| warning: false
#| echo: false
#| fig-height: 6

library(ggplot2)
library(dplyr)
library(tidyr)
library(scales)

all_metrics_XGB = readRDS("data/all_metrics_XGB_tuned_models.rds")

train_metrics <- all_metrics_XGB %>% 
  filter(Dataset == "Train") %>% 
  mutate(fill_norm = rescale(Rsquared), 
         text_color = ifelse(fill_norm > 0.25, "white", "black"))  # text is black if background is light
test_metrics  <- all_metrics_XGB %>% 
  filter(Dataset == "Test") %>% 
  mutate(fill_norm = rescale(Rsquared), 
         text_color = ifelse(fill_norm > 0.5, "white", "black"))  # text is black if background is light

# Shared fill scale
Rsq_limits <- c(min(all_metrics_XGB$Rsquared, na.rm = TRUE),
                quantile(all_metrics_XGB$Rsquared, 1, na.rm = TRUE))

# Train Rsquared heatmap
p1 <- ggplot(train_metrics, aes(x = Model, y = Drug, fill = Rsquared)) +
  geom_tile(color = "white") +
  geom_text(aes(label = signif(Rsquared, 2),
                color = text_color),
            size = 3, angle = 45, 
            show.legend = FALSE) +
  scale_color_identity() +  # use colors as-is from the column
  scale_fill_viridis_c(option = "magma", direction = -1, name = "R^2", limits = Rsq_limits) + 
  labs(title = "Training Data Rsquared", x = "Model", y = NULL) +
  theme_minimal(base_size = 10) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Test Rsquared heatmap
p2 <- ggplot(test_metrics, aes(x = Model, y = Drug, fill = Rsquared)) +
  geom_tile(color = "white") +
  geom_text(aes(label = signif(Rsquared, 2),
                color = text_color),
            size = 3, angle = 45, 
            show.legend = FALSE) +
  scale_color_identity() +  # use colors as-is from the column
  scale_fill_viridis_c(option = "magma", direction = -1, name = "R^2", limits = Rsq_limits) +
  labs(title = "Test Data Rsquared", x = "Model", y = NULL) +
  theme_minimal(base_size = 10) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
# Combine
(p1 + p2) + plot_layout(guides = "collect") & theme(legend.position = "right")


```

### Feature Importance
 The most important features for the initial XGB model across all drugs are shown in the heatmap below (@fig-heatmap-rf-variable-importance). The most obvious pattern here is that the num_contract_plans (aka the quantity of available Medicare plans) is the most important feature for 12 out of the 14 top drugs. We already looked at the connection between total_population and the quantity of available plans in a county previously, and only saw a mild correlation. For the other two drugs, the top features were income per capita and percent of the population with master's degree.


``` {r}
#| label: fig-heatmap-rf-variable-importance
#| fig-cap: "Top 5 Variable Importance Heatmap by Drug for XGB Model"
#| warning: false
#| echo: false
#| fig-height: 6

library(ggplot2)

# top_rf_vars2 <- readRDS("data/top_rf_vars2.rds")
# 
# ggplot(top_rf_vars2, aes(x = Variable, y = Drug, fill = Overall)) +
#   geom_tile(color = "white") +
#   geom_text(aes(label = signif(Overall, 2), color = label_color), size = 3) +
#   scale_color_identity() +  # use colors directly from label_color
#   scale_fill_viridis_c(option = "magma", name = "Importance") +
#   coord_flip() +
#   labs(
#     title = "Random Forest Variable Importance Heatmap by Drug",
#     x = NULL, #"Variable",
#     y = NULL #"Drug"
#   ) +
#   theme_minimal() +
#   theme(
#     axis.text.x = element_text(angle = 90, hjust = 1)
#   )

all_varimp_clean = readRDS("data/all_varimp_clean.rds")

ggplot(all_varimp_clean, aes(x = Drug_Model, y = Variable, fill = NormalizedImportance)) +
  geom_tile(color = "white") +
  geom_text(aes(label = round(NormalizedImportance, 1), color = TextColor), 
            size = 3, 
            angle = 0) +
  scale_fill_viridis_c(option = "magma", name = "Normalized\nImportance") +
  scale_color_identity() +  # Use colors as-is from the column
  labs(title = "Top 5 Variable Importances for Each Drug with a XGB Model",
       x = NULL,
       y = NULL) +
  theme_minimal(base_size = 10) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) 
  # coord_flip()


```

We did a quick linear regression fit between the median price of all drugs and the number of available Medicare plans in a county. The results are shown in the below table. The percent of the price variance is that is due to the number of available Medicare plans was pulled from the R^2 value. The direction of the relationship is shown as either an increase (↑) or decrease (↓) in price with an increase in the number of available plans. The significance of the relationship was determined by a p-value < 0.05. The interpretation of the relationship is based on the slope of the fit, which indicates how much the median price changes with each additional Medicare plan available in a county.


``` {r}
#| label: fig-effect-available-plans-on-drug-price
#| fig-cap: "Effect of Available Plans on Drug Price"
#| warning: false
#| echo: false

library(ggplot2)
library(dplyr)
library(ggrepel)

# Data
df <- tibble::tibble(
  Drug = c("Adalimumab", "Apixaban", "Dulaglutide", "Empagliflozin", "Etanercept",
           "Ibrutinib", "Insulin Aspart", "Lenalidomide", "Liraglutide",
           "Paliperidone Palmitate", "Rivaroxaban", "Semaglutide",
           "Tiotropium Bromide", "Ustekinumab"),
  MedianPrice = c(3497, 9, 448, 10, 1720, 536, 34, 712, 81, 3575, 17, 261, 119, 26041),
  PercentChange = c(0.05, -0.01, -0.02, 0.09, 0.03, 0.03, -0.01, 0.35, -1.59,
                    0.03, -0.06, -0.53, 0.12, -0.02),
  VarianceExplained = c(0.84, 0.04, 0.11, 0.33, 0.30, 0.22, 0, 5.01, 4.20,
                        0.21, 2.84, 2.58, 6.35, 0.13),
  Significant = c(TRUE, FALSE, FALSE, TRUE, TRUE, TRUE, FALSE, TRUE, TRUE,
                  TRUE, TRUE, TRUE, TRUE, TRUE)
)

# Plot
ggplot(df, aes(x = PercentChange, y = MedianPrice,
               size = VarianceExplained, color = Significant)) +
  geom_point(alpha = 0.8) +
  scale_y_log10(labels = scales::dollar_format()) +
  scale_color_manual(values = c("gray60", "darkgreen")) +
  scale_size_continuous(range = c(2, 10), 
                breaks = seq(0, 6, by = 2), 
                labels = scales::percent_format(scale = 1)) +
  # scale_shape_manual(values = c("Increase" = 16, "Decrease" = 17)) +
  geom_text_repel(aes(label = Drug), size = 3, max.overlaps = 10, box.padding = 1, point.padding = 1) +
  labs(
    title = "Effect of Available Plans on Drug Price",
    x = "% Change in Price per 10 More Plans",
    y = "Median Price (log10 USD)",
    size = "Explains x% of Variance",
    color = "Statistically Significant"
    # shape = "Direction"
  ) +
  theme_minimal(base_size = 10) +
  geom_vline(xintercept = 0, linetype = "dashed")
```




### Machine Learning (ML) Conclusions

The application of diverse machine learning algorithms provided valuable insights into the complex relationships between demographic factors and medication prices across U.S. counties. Despite the initial hypothesis that demographic variables might strongly predict drug pricing disparities, our results indicate that the quantity of Medicare plans available within a county is the most consistent and influential predictor across the majority of the top-spending medications. Other demographic features, such as education level, income, and racial composition, showed variable importance depending on the specific drug but did not emerge as universally strong predictors.

The superior performance of random forest modelling highlights the nonlinear and multifaceted nature of drug pricing patterns, which simpler linear models struggled to capture effectively. This complexity underscores the challenge of modeling medication prices purely based on demographics and points to the potential influence of additional factors not captured in our current dataset.

Overall, these findings suggest that while demographic characteristics contribute to medication price variation, market dynamics (reflected by Medicare plan availability) play a pivotal role. Future work may benefit from incorporating additional economic, regulatory, and supply-chain data to better explain and predict geographic disparities in medication costs. This knowledge could ultimately inform policies aimed at improving affordability and equity in drug pricing.














